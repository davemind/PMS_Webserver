<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Log Page</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="static/menu-table/plugins/fontawesome-free/css/all.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="static/menu-table/dist/css/adminlte.min.css">

</head>

<script>
function load(){
	$.ajax({
		url: "/bk/Log/Menu",
		type: "POST",
		error: function (result) {
			alert("There is a Problem, Try Again!");
		},
		success: function (result) {
			var data = JSON.parse(result);
			if(data['statusCode'] == '403'){
				top.location="/"
			}
			else {
				menu_items = data['menu_items']
				table_items = data['table_items']
				var menu = document.getElementById("menu");
				for (var i = 0; i < menu_items.length; ++i) {
					var item=document.createElement("li");
					item.setAttribute("class","nav-item d-none d-sm-inline-block");
					var A = document.createElement("A");
					A.setAttribute("href", menu_items[i][1]);
					A.setAttribute("class","nav-link");
					A.appendChild(document.createTextNode(menu_items[i][0]));
					item.appendChild(A);
					menu.appendChild(item);
				}
				var tbody = document.getElementById("table").getElementsByTagName("tbody")[0];
				indices = [1, 2, 5, 8, 10, 13, 15, 16, 17, 18, 19]
				fields = ['', 'tractor_lpr', 'tractor_num', 'company', 'trailer_lpr', 'container_num', 'seal_num', '', 'clear', '', 'remarks']
				categories = ['label', 'back_img_input', 'back_img_input', 'conf_input', 'back_img_input', 'conf_input', 'normal_input', 'label', 'combo', 'label', 'textarea']
				for (var i = 0; i < table_items.length; ++i) {
					var row = document.createElement("tr");
					for (var j in indices) {
						var data1 = document.createElement("td");
						if (categories[j] == 'label'){
							data1.appendChild(document.createTextNode(table_items[i][indices[j]]));
						}
						else if (categories[j] == 'combo'){
							var select = document.createElement("select");
							select.setAttribute('log_id', table_items[i][0]);
							select.setAttribute('class', 'select_value');
							select.setAttribute('field', fields[j]);
							select.options[0] = new Option('No', 0);
							select.options[1] = new Option('Yes', 1);
							select.selectedIndex = table_items[i][indices[j]];
							data1.appendChild(select);
							
							data1.setAttribute("data-search", table_items[i][indices[j]]);
							data1.setAttribute("data-order", table_items[i][indices[j]]);
						}
						else if (categories[j] == 'normal_input'){
							data1.innerHTML="<input class='input_value' style='width:100%;' value='" + table_items[i][indices[j]] + "' log_id='" + table_items[i][0] + "' field='" + fields[j] + "'/>";
							
							data1.setAttribute("data-search", table_items[i][indices[j]]);
							data1.setAttribute("data-order", table_items[i][indices[j]]);
						}
						else if (categories[j] == 'textarea'){
							data1.innerHTML="<textarea class='input_value' style='width:100%;' log_id='" + table_items[i][0] + "' field='" + fields[j] + "'>" + table_items[i][indices[j]] + "</textarea>";
							data1.setAttribute("data-search", table_items[i][indices[j]]);
							data1.setAttribute("data-order", table_items[i][indices[j]]);
						}
						else {
							if (table_items[i][indices[j] + 1] < 50){color = 'red';}
							else if (table_items[i][indices[j] + 1] < 70){color = 'orange';}
							else if (table_items[i][indices[j] + 1] < 80){color = 'yellow';}
							else if (table_items[i][indices[j] + 1] < 90){color = 'blue';}
							else {color = 'green';}
							if (categories[j] == 'back_img_input'){
								data1.innerHTML="<div><input type='text' class='input_value show_image' style='width:100%;color:" + color + ";' value='" + table_items[i][indices[j]] + "' log_id='" + table_items[i][0] + "' field='" + fields[j] + "' title='confidence = " + table_items[i][indices[j] + 1] + "' data-image='" + table_items[i][indices[j] + 2] + "'/></div>";
							}
							else{
								data1.innerHTML="<div><input type='text' class='input_value' style='width:100%;color:" + color + ";' value='" + table_items[i][indices[j]] + "' log_id='" + table_items[i][0] + "' field='" + fields[j] + "' title='confidence = " + table_items[i][indices[j] + 1] + "'/></div>";
							}
							data1.setAttribute("data-search", table_items[i][indices[j]]);
							data1.setAttribute("data-order", table_items[i][indices[j]]);
						}
						
						row.appendChild(data1);
					}
					tbody.appendChild(row);
				};
				$(".input_value").blur(function () {
					log_update($(this).attr('field'), $(this).val(), $(this).attr('log_id'));
				});
				$(".show_image").mouseenter(function () {
					if ($(this).parent('div').children('div.image').length) {
						$(this).parent('div').children('div.image').show();
					} else {
						var image_name=$(this).data('image');
						var imageTag='<div class="image" style="position:absolute;">'+'<img src="'+image_name+'" alt="image" height="100" />'+'</div>';
						$(this).parent('div').append(imageTag);
					}
				});
				$(".show_image").mouseleave(function(){
					$(this).parent('div').children('div.image').hide();
				});
				$(".select_value").change(function () {
					log_update($(this).attr('field'), $(this).val(), $(this).attr('log_id'));
				});
				
				//function for DataTable data export to export <input>.value
				var buttonCommon = {
					exportOptions: {
						format: {
							body: function ( data, row, column, node ) {
								//check if type is input using jquery
								return node.firstChild.tagName === "INPUT" ?
										node.firstElementChild.value :
										data;

							}
						}
					}
				};
				var table = $("#table").DataTable({
                        "orderCellsTop": true,
                        "fixedHeader": true,
                        "processing": true,
                        "bDestroy": true,
                        "order": [[0, "desc"]],
                        "aLengthMenu": [[10, 20, 30, 50, -1], [10, 20, 30, 50, 'All']],
                        "dom": 'Blfrtip',
                         buttons: [
                            {
                                extend: 'excel',
                                text: '<span class="fa fa-file-pdf-o"></span> Excel',
                                footer: false,
                                exportOptions: {
                                    columns: [0, 1, 3, 4, 5, 6, 7, 8, 9],
									format: {
										body: function ( data, row, column, node ) {
											//check if type is input using jquery
											if(node.firstChild.tagName === "DIV")
												return node.firstElementChild.firstElementChild.value;
											else if(node.firstChild.tagName === "INPUT")
												return node.firstElementChild.value;
											else if(node.firstChild.tagName === "SELECT")
												return node.firstElementChild.value;
											else
												return data;
											

										}
									}
                                },
                                title: 'Log Details',
                            },
                            {
                                extend: 'pdf',
                                text: '<span class="fa fa-file-pdf-o"></span> PDF',
                                footer: false,
                                exportOptions: {
                                    columns: [0, 1, 3, 4, 5, 6, 7, 8, 9],
									format: {
										body: function ( data, row, column, node ) {
											//check if type is input using jquery
											if(node.firstChild.tagName === "DIV")
												return node.firstElementChild.firstElementChild.value;
											else if(node.firstChild.tagName === "INPUT")
												return node.firstElementChild.value;
											else if(node.firstChild.tagName === "SELECT")
												return node.firstElementChild.value;
											else
												return data;

										}
									}
                                },
                                title: 'Log Details',
                                orientation: 'landscape',
                                pageSize: 'LEGAL',
                            }
                        ]
                    });
			}
		},
	});
}
</script>

<body  class="hold-transition sidebar-mini" onload="load()">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav" id="menu">
    </ul>
  </nav>	
  <div class="card-body">
	<table id="table" class="table table-bordered table-hover" style="width:100%; table-layout: fixed; overflow-wrap: anywhere;">
	  <thead>
	  <tr>
		<th style="width:10%;">Tran Start</th>
		<th style="width:8%;">Tractor LP</th>
		<th style="width:8%;">Tractor</th>
		<th style="width:8%;">Company</th>
		<th style="width:8%;">Trailer LP</th>
		<th style="width:8%;">Container number</th>
		<th style="width:8%;">Seal number</th>
		<th style="width:8%;">Driver License</th>
		<th style="width:4%;">Clear</th>
		<th style="width:10%;">Tran End Time</th>
		<th style="width:20%;">Remarks</th>
	  </tr>
	  </thead>
	  <tbody>
	  </tbody>
	</table>
  </div>

	
<!-- jQuery -->
<script src="static/menu-table/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="static/menu-table/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- DataTables -->
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.flash.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.print.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/fixedheader/3.1.7/js/dataTables.fixedHeader.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.1.7/css/fixedHeader.dataTables.min.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.6.5/css/buttons.dataTables.min.css" />
<script>

	function log_update(field, value, log_id){
		$.ajax({
			url: "/bk/Log",
			type: "PUT",
			data: {
				field: field,
				value: value,
				log_id: log_id,
			},
			error: function (result) {
				alert("There is a Problem, Try Again!");
			},
			success: function (result) {
			}
		});
	};
</script>
</body>
</html>
